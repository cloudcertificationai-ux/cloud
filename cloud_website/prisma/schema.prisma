generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model APIErrorLog {
  id           String   @id
  requestId    String
  method       String
  path         String
  statusCode   Int
  errorMessage String
  errorStack   String?
  userId       String?
  timestamp    DateTime
  metadata     Json     @default("{}")
  createdAt    DateTime @default(now())

  @@index([requestId])
  @@index([statusCode])
  @@index([timestamp])
  @@index([userId])
}

model APIPerformanceLog {
  id           String   @id
  requestId    String
  method       String
  path         String
  statusCode   Int
  responseTime Int
  userId       String?
  timestamp    DateTime
  metadata     Json     @default("{}")
  createdAt    DateTime @default(now())

  @@index([path])
  @@index([requestId])
  @@index([timestamp])
  @@index([userId])
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model ApiKey {
  id         String    @id
  keyName    String
  apiKey     String    @unique
  apiSecret  String
  createdAt  DateTime  @default(now())
  expiresAt  DateTime?
  lastUsedAt DateTime?
  isActive   Boolean   @default(true)

  @@index([apiKey])
  @@index([isActive])
}

model Assignment {
  id                   String                 @id
  title                String
  description          String
  dueDate              DateTime
  maxMarks             Int
  requirements         String
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  AssignmentSubmission AssignmentSubmission[]
  Lesson               Lesson[]
}

model AssignmentSubmission {
  id                                       String     @id
  assignmentId                             String
  userId                                   String
  r2Key                                    String
  fileName                                 String
  submittedAt                              DateTime   @default(now())
  isLate                                   Boolean    @default(false)
  marks                                    Int?
  feedback                                 String?
  gradedAt                                 DateTime?
  gradedBy                                 String?
  createdAt                                DateTime   @default(now())
  updatedAt                                DateTime
  Assignment                               Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  User_AssignmentSubmission_gradedByToUser User?      @relation("AssignmentSubmission_gradedByToUser", fields: [gradedBy], references: [id])
  User_AssignmentSubmission_userIdToUser   User       @relation("AssignmentSubmission_userIdToUser", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([assignmentId, userId])
  @@index([assignmentId])
  @@index([userId])
}

model AuditLog {
  id           String   @id
  userId       String?
  action       String
  resourceType String
  resourceId   String?
  details      Json?
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())
  User         User?    @relation(fields: [userId], references: [id])

  @@index([action])
  @@index([createdAt])
  @@index([resourceType])
  @@index([userId])
}

model BlogPost {
  id              String    @id @default(cuid())
  title           String
  slug            String    @unique
  excerpt         String?   @db.Text
  content         String    @db.Text
  coverImageUrl   String?
  coverImageKey   String?
  published       Boolean   @default(false)
  featured        Boolean   @default(false)
  views           Int       @default(0)
  authorId        String
  author          User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  tags            String[]  @default([])
  metaTitle       String?
  metaDescription String?   @db.Text
  publishedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([slug])
  @@index([published])
  @@index([featured])
  @@index([authorId])
  @@index([publishedAt])
}

model Category {
  id     String   @id
  name   String   @unique
  slug   String   @unique
  Course Course[]

  @@index([slug])
}

model ContactSubmission {
  id               String        @id
  name             String
  email            String
  phone            String?
  subject          String
  message          String
  interestedCourse String?
  status           ContactStatus @default(NEW)
  notes            String?
  respondedAt      DateTime?
  respondedBy      String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime
  countryCode      String?       @default("+91")

  @@index([createdAt])
  @@index([email])
  @@index([status])
}

model Course {
  id             String           @id
  title          String
  slug           String           @unique
  summary        String?
  description    String?
  priceCents     Int              @default(0)
  currency       String           @default("INR")
  published      Boolean          @default(false)
  featured       Boolean          @default(false)
  level          String?
  durationMin    Int?
  rating         Float?           @default(0)
  thumbnailUrl   String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  instructorId   String?
  categoryId     String?
  Category       Category?        @relation(fields: [categoryId], references: [id])
  Instructor     Instructor?      @relation(fields: [instructorId], references: [id])
  CourseProgress CourseProgress[]
  Enrollment     Enrollment[]
  Module         Module[]
  Purchase       Purchase[]
  Review         Review[]
  Testimonial    Testimonial[]

  @@index([categoryId])
  @@index([featured])
  @@index([instructorId])
  @@index([published])
  @@index([slug])
}

model CourseProgress {
  id           String    @id
  userId       String
  courseId     String
  lessonId     String?
  completed    Boolean   @default(false)
  timeSpent    Int       @default(0)
  lastPosition Int       @default(0)
  timestamp    DateTime  @default(now())
  completedAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime
  watchedSec   Int       @default(0)
  Course       Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  Lesson       Lesson?   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  User         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([completed])
  @@index([courseId])
  @@index([userId, courseId])
  @@index([userId])
}

model DailyStatistics {
  id                    String   @id
  date                  DateTime @unique
  totalUploads          Int      @default(0)
  totalTranscodes       Int      @default(0)
  successfulTranscodes  Int      @default(0)
  failedTranscodes      Int      @default(0)
  totalPlaybackSessions Int      @default(0)
  totalWatchTime        Int      @default(0)
  averageCompletionRate Float    @default(0)
  totalAPIRequests      Int      @default(0)
  totalAPIErrors        Int      @default(0)
  averageResponseTime   Float    @default(0)
  createdAt             DateTime @default(now())
  updatedAt             DateTime

  @@index([date])
}

model Enrollment {
  id                   String           @id
  userId               String
  courseId             String
  enrolledAt           DateTime         @default(now())
  lastAccessedAt       DateTime?
  completionPercentage Float            @default(0)
  status               EnrollmentStatus @default(ACTIVE)
  source               String
  purchaseId           String?          @unique
  Course               Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  Purchase             Purchase?        @relation(fields: [purchaseId], references: [id])
  User                 User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId])
  @@index([enrolledAt])
  @@index([status])
  @@index([userId])
}

model Instructor {
  id      String   @id
  name    String
  bio     String?
  avatar  String?
  company String?
  Course  Course[]

  @@index([name])
}

model Lesson {
  id             String           @id
  title          String
  content        String?
  videoUrl       String?
  duration       Int?
  order          Int
  moduleId       String
  assignmentId   String?
  createdAt      DateTime         @default(now())
  kind           LessonKind       @default(VIDEO)
  mediaId        String?
  quizId         String?
  updatedAt      DateTime
  CourseProgress CourseProgress[]
  Assignment     Assignment?      @relation(fields: [assignmentId], references: [id])
  Media          Media?           @relation(fields: [mediaId], references: [id])
  Module         Module           @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  Quiz           Quiz?            @relation(fields: [quizId], references: [id])

  @@index([assignmentId])
  @@index([mediaId])
  @@index([moduleId])
  @@index([order])
  @@index([quizId])
}

model Media {
  id           String      @id
  originalName String
  r2Key        String      @unique
  manifestUrl  String?
  thumbnails   Json        @default("[]")
  duration     Int?
  width        Int?
  height       Int?
  fileSize     BigInt
  mimeType     String
  status       MediaStatus @default(UPLOADED)
  metadata     Json        @default("{}")
  uploadedBy   String
  createdAt    DateTime    @default(now())
  updatedAt    DateTime
  Lesson       Lesson[]
  User         User        @relation(fields: [uploadedBy], references: [id])

  @@index([status])
  @@index([uploadedBy])
}

model Module {
  id       String   @id
  title    String
  order    Int
  courseId String
  Lesson   Lesson[]
  Course   Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
  @@index([order])
}

model PlaybackSession {
  id             String    @id
  userId         String
  mediaId        String
  lessonId       String
  courseId       String
  sessionId      String    @unique
  startedAt      DateTime
  endedAt        DateTime?
  watchTime      Int       @default(0)
  completionRate Float     @default(0)
  metadata       Json      @default("{}")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime

  @@index([courseId])
  @@index([lessonId])
  @@index([mediaId])
  @@index([startedAt])
  @@index([userId])
}

model Profile {
  id       String  @id
  userId   String  @unique
  bio      String?
  location String?
  timezone String?
  phone    String?
  User     User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Purchase {
  id          String         @id
  userId      String
  courseId    String
  amountCents Int
  currency    String
  provider    String
  providerId  String?
  status      PurchaseStatus @default(PENDING)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime
  Enrollment  Enrollment?
  Course      Course         @relation(fields: [courseId], references: [id])
  User        User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([courseId])
  @@index([createdAt])
  @@index([providerId])
  @@index([status])
  @@index([userId])
}

model Question {
  id            String       @id
  quizId        String
  text          String
  type          QuestionType
  options       Json         @default("[]")
  correctAnswer Json
  explanation   String?
  points        Int          @default(1)
  order         Int
  createdAt     DateTime     @default(now())
  updatedAt     DateTime
  Quiz          Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([quizId])
}

model Quiz {
  id           String        @id
  title        String
  description  String
  timeLimit    Int
  passingScore Int
  createdAt    DateTime      @default(now())
  updatedAt    DateTime
  Lesson       Lesson[]
  Question     Question[]
  QuizAttempt  QuizAttempt[]
}

model QuizAttempt {
  id          String   @id
  quizId      String
  userId      String
  answers     Json     @default("{}")
  score       Int
  passed      Boolean
  submittedAt DateTime @default(now())
  Quiz        Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([quizId, userId])
  @@index([userId])
}

model Review {
  id        String   @id
  userId    String
  courseId  String
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  Course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId])
  @@index([rating])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  lastActivity DateTime @default(now())
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expires])
  @@index([userId])
}

model Testimonial {
  id        String   @id
  courseId  String
  author    String
  message   String
  createdAt DateTime @default(now())
  Course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
}

model TranscodeJobLog {
  id           String    @id
  mediaId      String
  jobId        String
  status       String
  startedAt    DateTime?
  completedAt  DateTime?
  duration     Int?
  errorMessage String?
  errorStack   String?
  metadata     Json      @default("{}")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime

  @@index([jobId])
  @@index([mediaId])
  @@index([startedAt])
  @@index([status])
}

model User {
  id                                                       String                 @id
  email                                                    String                 @unique
  emailVerified                                            DateTime?
  name                                                     String?
  image                                                    String?
  role                                                     UserRole               @default(STUDENT)
  createdAt                                                DateTime               @default(now())
  updatedAt                                                DateTime
  lastLoginAt                                              DateTime?
  password                                                 String?
  Account                                                  Account[]
  AssignmentSubmission_AssignmentSubmission_gradedByToUser AssignmentSubmission[] @relation("AssignmentSubmission_gradedByToUser")
  AssignmentSubmission_AssignmentSubmission_userIdToUser   AssignmentSubmission[] @relation("AssignmentSubmission_userIdToUser")
  AuditLog                                                 AuditLog[]
  BlogPost                                                 BlogPost[]
  CourseProgress                                           CourseProgress[]
  Enrollment                                               Enrollment[]
  Media                                                    Media[]
  Profile                                                  Profile?
  Purchase                                                 Purchase[]
  QuizAttempt                                              QuizAttempt[]
  Review                                                   Review[]
  Session                                                  Session[]

  @@index([email])
  @@index([role])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum ContactStatus {
  NEW
  IN_PROGRESS
  RESPONDED
  CLOSED
}

enum EnrollmentStatus {
  ACTIVE
  CANCELLED
  COMPLETED
  REFUNDED
}

enum LessonKind {
  VIDEO
  ARTICLE
  QUIZ
  MCQ
  ASSIGNMENT
  AR
  LIVE
}

enum MediaStatus {
  UPLOADED
  PROCESSING
  READY
  FAILED
}

enum PurchaseStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum QuestionType {
  SINGLE_CHOICE
  MULTIPLE_CHOICE
  TEXT_ANSWER
}

enum UserRole {
  ADMIN
  INSTRUCTOR
  STUDENT
}
